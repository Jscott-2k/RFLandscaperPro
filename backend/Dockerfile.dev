# syntax=docker/dockerfile:1

# ---- Base image ----
ARG NODE_VERSION=24.3.0
FROM node:${NODE_VERSION}-slim AS base

# ---- Set working directory ----
WORKDIR /app

# ---- Set default environment ----
# Allows NestJS to fall back to .env.development when run via `docker run`
ENV NODE_ENV=development
ENV CHOKIDAR_USEPOLLING=true

# ---- Install dependencies ----
# Use root workspace lockfile to install backend dependencies
COPY package.json package-lock.json ./
COPY backend/package.json backend/package.json
COPY shared/package.json shared/package.json
RUN npm ci --include=dev --workspace backend

# ---- Copy application code ----
# Copy backend and shared sources into dedicated workspace directories
COPY backend/ backend/
COPY shared/ shared/

# ---- Expose application port ----
EXPOSE 3000

# ---- Start development server with live reload ----
CMD ["npm", "run", "start:dev", "--workspace", "backend"]
